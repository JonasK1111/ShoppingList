"""
Einkaufslisten-Manager (GUI)

- Rechts: Tabelle mit Nr., Name, Anzahl, Preis (Gesamtpreis pro Item)
- Unten: Gesamtanzahl Items und Gesamtpreis
- Links: Buttons "Item hinzufügen" und "Item entfernen"
  - "Item hinzufügen": linke Seite zeigt Eingabemaske (Name, Anzahl, Stückpreis)
  - "Item entfernen": Nutzer wählt ein Item in der Liste und wird per Dialog gefragt,
    ob es wirklich gelöscht werden soll.

Struktur:
- ShoppingItem: Datenklasse für ein Listenelement (Model)
- ShoppingList: Verwaltet alle Items (Model / Business-Logic)
- ShoppingListApp: Tkinter-GUI, die das Model anzeigt und steuert (View/Controller)
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import List
import tkinter as tk
from tkinter import ttk, messagebox


# ==========================
#   Datenmodell
# ==========================

@dataclass
class ShoppingItem:
    """Repräsentiert einen Eintrag in der Einkaufsliste."""
    name: str
    quantity: int
    unit_price: float

    @property
    def total_price(self) -> float:
        """Berechnet den Gesamtpreis (Anzahl * Stückpreis)."""
        return self.quantity * self.unit_price


class ShoppingList:
    """Verwaltet die Liste von ShoppingItems (Model)."""

    def __init__(self) -> None:
        self._items: List[ShoppingItem] = []

    def add_item(self, item: ShoppingItem) -> None:
        """Fügt ein neues Item zur Liste hinzu."""
        self._items.append(item)

    def remove_item_at(self, index: int) -> None:
        """Entfernt ein Item an einer bestimmten Position, falls vorhanden."""
        if 0 <= index < len(self._items):
            del self._items[index]

    def get_items(self) -> List[ShoppingItem]:
        """Gibt eine Kopie der aktuellen Liste zurück (Read-Only nach außen)."""
        return list(self._items)

    def total_quantity(self) -> int:
        """Gesamtanzahl aller Items (Summe der Mengen)."""
        return sum(item.quantity for item in self._items)

    def total_price(self) -> float:
        """Gesamtpreis aller Items."""
        return sum(item.total_price for item in self._items)


# ==========================
#   GUI / Anwendung
# ==========================

class ShoppingListApp(tk.Tk):
    """Tkinter-GUI für den Einkaufslisten-Manager."""

    def __init__(self, shopping_list: ShoppingList) -> None:
        super().__init__()

        self.title("Einkaufslisten-Manager")
        self.geometry("800x400")
        self.minsize(700, 350)

        # Referenz auf das Model
        self.shopping_list = shopping_list

        # Fonts / Styles
        self.style = ttk.Style(self)
        self.style.theme_use("clam")

        # GUI-Elemente erzeugen
        self._create_layout()
        self._create_left_views()
        self._create_right_table()
        self._create_bottom_summary()

        # Initialer Zustand
        self._show_main_menu_view()
        self._refresh_table()
        self._update_summary()

    # ---------- Layout-Grundstruktur ----------

    def _create_layout(self) -> None:
        """Grundraster: linke Steuerleiste, rechte Tabelle, untere Zusammenfassung."""
        self.columnconfigure(0, weight=0)   # links (Buttons / Form)
        self.columnconfigure(1, weight=1)   # rechts (Tabelle)
        self.rowconfigure(0, weight=1)      # Hauptbereich
        self.rowconfigure(1, weight=0)      # Fußbereich (Summen)

        # Rahmen links und rechts
        self.left_frame = ttk.Frame(self, padding=(0, 0, 10, 0))
        self.left_frame.grid(row=0, column=0, sticky="nsw")

        self.right_frame = ttk.Frame(self)
        self.right_frame.grid(row=0, column=1, sticky="nsew")

        # Rahmen unten
        self.bottom_frame = ttk.Frame(self, padding=(0, 10, 0, 0))
        self.bottom_frame.grid(row=1, column=0, columnspan=2, sticky="ew")

    # ---------- Linke Seite: Hauptmenü + Add-Form ----------

    def _create_left_views(self) -> None:
        """Erzeugt zwei "Ansichten" für die linke Seite: Hauptmenü und Add-Form."""
        self.left_frame.rowconfigure(0, weight=1)

        # Frame 1: Hauptmenü mit Buttons
        self.main_menu_frame = ttk.Frame(self.left_frame)
        self.main_menu_frame.grid(row=0, column=0, sticky="n")

        ttk.Label(
            self.main_menu_frame,
            text="Aktionen",
            font=("Segoe UI", 11, "bold"),
        ).pack(anchor="w", pady=(0, 10))

        self.btn_add_item = ttk.Button(
            self.main_menu_frame,
            text="Item hinzufügen",
            command=self._show_add_item_view,
        )
        self.btn_add_item.pack(fill="x", pady=(0, 5))

        self.btn_remove_item = ttk.Button(
            self.main_menu_frame,
            text="Item entfernen",
            command=self._on_remove_item,
        )
        self.btn_remove_item.pack(fill="x")

        # Frame 2: Formular zum Hinzufügen
        self.add_item_frame = ttk.Frame(self.left_frame)

        ttk.Label(
            self.add_item_frame,
            text="Neues Item hinzufügen",
            font=("Segoe UI", 11, "bold"),
        ).grid(row=0, column=0, columnspan=2, sticky="w", pady=(0, 10))

        ttk.Label(self.add_item_frame, text="Name:").grid(row=1, column=0, sticky="w")
        self.entry_name = ttk.Entry(self.add_item_frame, width=20)
        self.entry_name.grid(row=1, column=1, sticky="ew", pady=2)

        ttk.Label(self.add_item_frame, text="Anzahl:").grid(row=2, column=0, sticky="w")
        self.entry_quantity = ttk.Entry(self.add_item_frame, width=20)
        self.entry_quantity.grid(row=2, column=1, sticky="ew", pady=2)

        ttk.Label(self.add_item_frame, text="Stückpreis (€):").grid(
            row=3, column=0, sticky="w"
        )
        self.entry_unit_price = ttk.Entry(self.add_item_frame, width=20)
        self.entry_unit_price.grid(row=3, column=1, sticky="ew", pady=2)

        # Button-Leiste unten
        button_frame = ttk.Frame(self.add_item_frame)
        button_frame.grid(row=4, column=0, columnspan=2, pady=(10, 0), sticky="ew")

        self.btn_confirm_add = ttk.Button(
            button_frame, text="Hinzufügen", command=self._on_confirm_add_item
        )
        self.btn_confirm_add.pack(side="left", expand=True, fill="x", padx=(0, 5))

        self.btn_cancel_add = ttk.Button(
            button_frame, text="Abbrechen", command=self._show_main_menu_view
        )
        self.btn_cancel_add.pack(side="left", expand=True, fill="x")

        # Spalten konfigurieren (für saubere Ausrichtung)
        self.add_item_frame.columnconfigure(0, weight=0)
        self.add_item_frame.columnconfigure(1, weight=1)

    def _show_main_menu_view(self) -> None:
        """Zeigt die normale Ansicht mit den zwei Buttons."""
        self.add_item_frame.grid_forget()
        self.main_menu_frame.grid(row=0, column=0, sticky="n")

    def _show_add_item_view(self) -> None:
        """Zeigt die Eingabemaske für ein neues Item."""
        # Felder leeren
        self.entry_name.delete(0, tk.END)
        self.entry_quantity.delete(0, tk.END)
        self.entry_unit_price.delete(0, tk.END)

        self.main_menu_frame.grid_forget()
        self.add_item_frame.grid(row=0, column=0, sticky="n")

    # ---------- Rechte Seite: Tabelle mit Items ----------

    def _create_right_table(self) -> None:
        """Erzeugt die Treeview-Tabelle für die Einkaufsliste."""
        columns = ("nr", "name", "quantity", "price")

        self.tree = ttk.Treeview(
            self.right_frame,
            columns=columns,
            show="headings",
            selectmode="browse",
        )

        self.tree.heading("nr", text="Nr.")
        self.tree.heading("name", text="Name")
        self.tree.heading("quantity", text="Anzahl")
        self.tree.heading("price", text="Preis gesamt (€)")

        self.tree.column("nr", width=50, anchor="center")
        self.tree.column("name", width=200, anchor="w")
        self.tree.column("quantity", width=80, anchor="center")
        self.tree.column("price", width=120, anchor="e")

        self.tree.grid(row=0, column=0, sticky="nsew")

        # Scrollbar
        scrollbar = ttk.Scrollbar(
            self.right_frame, orient="vertical", command=self.tree.yview
        )
        self.tree.configure(yscrollcommand=scrollbar.set)
        scrollbar.grid(row=0, column=1, sticky="ns")

        # Frame skalierbar machen
        self.right_frame.rowconfigure(0, weight=1)
        self.right_frame.columnconfigure(0, weight=1)

    def _refresh_table(self) -> None:
        """Aktualisiert die Tabelle basierend auf dem Model."""
        # Alte Einträge löschen
        for item_id in self.tree.get_children():
            self.tree.delete(item_id)

        # Neue Einträge einfügen
        for index, item in enumerate(self.shopping_list.get_items()):
            row_number = index + 1
            self.tree.insert(
                "",
                "end",
                iid=str(index),  # i.i.d. = index im Model
                values=(
                    row_number,
                    item.name,
                    item.quantity,
                    f"{item.total_price:.2f}",
                ),
            )

    # ---------- Untere Leiste: Zusammenfassung ----------

    def _create_bottom_summary(self) -> None:
        """Erzeugt Labels für Gesamtanzahl und Gesamtpreis."""
        self.bottom_frame.columnconfigure(0, weight=1)
        self.bottom_frame.columnconfigure(1, weight=1)

        self.label_total_items = ttk.Label(
            self.bottom_frame, text="Gesamtanzahl Items: 0"
        )
        self.label_total_items.grid(row=0, column=0, sticky="w")

        self.label_total_price = ttk.Label(
            self.bottom_frame, text="Gesamtpreis: 0.00 €"
        )
        self.label_total_price.grid(row=0, column=1, sticky="e")

    def _update_summary(self) -> None:
        """Aktualisiert die Summen-Anzeige unten."""
        total_qty = self.shopping_list.total_quantity()
        total_price = self.shopping_list.total_price()

        self.label_total_items.config(text=f"Gesamtanzahl Items: {total_qty}")
        self.label_total_price.config(text=f"Gesamtpreis: {total_price:.2f} €")

    # ---------- Logik für Buttons ----------

    def _on_confirm_add_item(self) -> None:
        """Wird aufgerufen, wenn im Add-Formular auf 'Hinzufügen' geklickt wird."""
        name = self.entry_name.get().strip()
        quantity_str = self.entry_quantity.get().strip()
        unit_price_str = self.entry_unit_price.get().strip()

        if not name:
            messagebox.showwarning("Ungültige Eingabe", "Bitte einen Namen eingeben.")
            return

        # Validierung für Anzahl und Stückpreis
        try:
            quantity = int(quantity_str)
            if quantity <= 0:
                raise ValueError
        except ValueError:
            messagebox.showwarning(
                "Ungültige Eingabe",
                "Die Anzahl muss eine ganze Zahl > 0 sein.",
            )
            return

        try:
            unit_price = float(unit_price_str.replace(",", "."))
            if unit_price < 0:
                raise ValueError
        except ValueError:
            messagebox.showwarning(
                "Ungültige Eingabe",
                "Der Stückpreis muss eine Zahl ≥ 0 sein.",
            )
            return

        # Item erstellen und ins Model aufnehmen
        new_item = ShoppingItem(name=name, quantity=quantity, unit_price=unit_price)
        self.shopping_list.add_item(new_item)

        # GUI aktualisieren
        self._refresh_table()
        self._update_summary()

        # Zur Hauptansicht zurück
        self._show_main_menu_view()

    def _on_remove_item(self) -> None:
        """
        Wird aufgerufen, wenn auf 'Item entfernen' geklickt wird.
        Erwartet, dass der Nutzer ein Item in der Tabelle ausgewählt hat.
        """
        selection = self.tree.selection()
        if not selection:
            messagebox.showinfo(
                "Kein Item ausgewählt",
                "Bitte wählen Sie zuerst ein Item in der Liste aus.",
            )
            return

        # Es gibt nur eine Auswahl, weil selectmode="browse"
        selected_iid = selection[0]
        try:
            index = int(selected_iid)
        except ValueError:
            # Sollte eigentlich nicht passieren, aber zur Sicherheit:
            messagebox.showerror(
                "Fehler",
                "Das ausgewählte Item konnte nicht ermittelt werden.",
            )
            return

        items = self.shopping_list.get_items()
        if not (0 <= index < len(items)):
            messagebox.showerror(
                "Fehler",
                "Das ausgewählte Item existiert nicht mehr.",
            )
            return

        item = items[index]

        # Bestätigungsdialog
        confirm = messagebox.askyesno(
            "Item löschen",
            f"Soll das Item '{item.name}' wirklich gelöscht werden?",
        )
        if not confirm:
            return

        # Item aus Model entfernen und GUI aktualisieren
        self.shopping_list.remove_item_at(index)
        self._refresh_table()
        self._update_summary()


# ==========================
#   Einstiegspunkt
# ==========================

def main() -> None:
    shopping_list = ShoppingList()
    app = ShoppingListApp(shopping_list)
    app.mainloop()


if __name__ == "__main__":
    main()
